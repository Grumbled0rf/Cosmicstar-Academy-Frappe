import{J as z,K as O,r as $,i as R,o as L,A as x,aT as A,e as p,f as i,k,j as P,h as c,g as a,n as T,l as e,a1 as G,_ as S,t as m,F as q,x as F,aI as H,aU as Q,aV as Y,p as B,aJ as E,C as J,H as I,L as Z,q as ee,aW as K,M as te,aX as se,N as oe}from"./index--jEUqk-V.js";import{_ as W}from"./UserAvatar-CWIXgT1I.js";const ae={class:"mt-6"},le={key:0,class:"flex items-center mb-5"},ne={class:"text-lg font-semibold ml-2 text-ink-gray-9"},re={class:"flex items-center justify-between mb-2"},ie={class:"flex items-center text-ink-gray-5"},de={class:"text-sm ml-2"},ce={key:1},ue={key:2,class:"flex justify-between mt-2"},N={__name:"DiscussionReplies",props:z({topic:{type:Object,required:!0},singleThread:{type:Boolean,default:!1}},{showTopics:{},showTopicsModifiers:{}}),emits:["update:showTopics"],setup(r){const _=O(r,"showTopics"),v=$(""),l=R("$socket"),w=R("$user"),h=R("$allUsers"),C=$([]),n=$(!1),d=window.read_only_mode,s=r;L(()=>{l.on("publish_message",t=>{g.reload()}),l.on("update_message",t=>{g.reload()}),l.on("delete_message",t=>{g.reload()}),f()});const g=x({url:"lms.lms.utils.get_discussion_replies",cache:["replies",s.topic],makeParams(t){return{topic:s.topic.name}},auto:!0}),V=x({url:"frappe.client.insert",makeParams(t){return{doc:{doctype:"Discussion Reply",reply:v.value,topic:s.topic.name}}}}),f=()=>{var t;(t=w.data)!=null&&t.is_student?n.value=!0:h.reload({},{onSuccess(y){C.value=Object.values(y).map(o=>({value:o.name,label:o.full_name})),n.value=!0}})},b=()=>{V.submit({},{validate(){if(!v.value)return"Reply cannot be empty"},onSuccess(){v.value="",g.reload()},onError(t){var y;I.error(((y=t.messages)==null?void 0:y[0])||t)}})},M=x({url:"frappe.client.set_value",makeParams(t){return{doctype:"Discussion Reply",name:t.name,fieldname:"reply",value:t.reply}}}),u=t=>{M.submit({name:t.name,reply:t.reply},{validate(){if(!t.reply)return"Reply cannot be empty"},onSuccess(){t.editable=!1,g.reload()}})},U=x({url:"frappe.client.delete",makeParams(t){return{doctype:"Discussion Reply",name:t.name}}}),j=t=>{U.submit({name:t.name},{onSuccess(){g.reload()}})};return A(()=>{l.off("publish_message"),l.off("update_message"),l.off("delete_message")}),(t,y)=>(i(),p("div",ae,[r.singleThread?k("",!0):(i(),p("div",le,[c(e(S),{variant:"outline",onClick:y[0]||(y[0]=o=>_.value=!0)},{icon:T(()=>[c(e(G),{class:"w-5 h-5 stroke-1.5 text-ink-gray-7"})]),_:1}),a("span",ne,m(r.topic.title),1)])),(i(!0),p(q,null,F(e(g).data,(o,X)=>(i(),p("div",null,[a("div",{class:J(["py-3",{"border-b":X+1!=e(g).data.length}])},[a("div",re,[a("div",ie,[c(W,{user:o.user,class:"mr-2"},null,8,["user"]),a("span",null,m(o.user.full_name),1),a("span",de,m(e(H)(o.creation)),1)]),e(w).data.name==o.owner&&!o.editable&&!e(d)?(i(),P(e(Y),{key:0,options:[{label:"Edit",onClick(){o.editable=!0}},{label:"Delete",onClick(){j(o)}}]},{default:T(({open:D})=>[c(e(Q),{class:"w-4 h-4 stroke-1.5 cursor-pointer"})]),_:2},1032,["options"])):k("",!0),o.editable?(i(),p("div",ce,[c(e(S),{variant:"ghost",onClick:D=>u(o)},{default:T(()=>[B(m(t.__("Post")),1)]),_:2},1032,["onClick"]),c(e(S),{variant:"ghost",onClick:D=>o.editable=!1},{default:T(()=>[B(m(t.__("Discard")),1)]),_:2},1032,["onClick"])])):k("",!0)]),c(e(E),{content:o.reply,onChange:D=>o.reply=D,editable:o.editable||!1,fixedMenu:o.editable||!1,editorClass:o.editable?"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-outline-gray-2 prose-th:border-outline-gray-2 prose-td:relative prose-th:relative prose-th:bg-surface-gray-2 prose-sm max-w-none":"prose-sm"},null,8,["content","onChange","editable","fixedMenu","editorClass"])],2)]))),256)),n.value&&!e(d)?(i(),P(e(E),{key:1,class:"mt-5",content:v.value,mentions:C.value,onChange:y[1]||(y[1]=o=>v.value=o),placeholder:"Type your reply here...",fixedMenu:!0,editorClass:"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-outline-gray-2 prose-th:border-outline-gray-2 prose-td:relative prose-th:relative prose-th:bg-surface-gray-2 prose-sm max-w-none border border-outline-gray-2 rounded-b-md min-h-[7rem] py-1 px-2"},null,8,["content","mentions"])):k("",!0),e(d)?k("",!0):(i(),p("div",ue,[y[3]||(y[3]=a("span",null,null,-1)),c(e(S),{onClick:y[2]||(y[2]=o=>b())},{default:T(()=>[a("span",null,m(t.__("Post")),1)]),_:1})]))]))}},pe={class:"flex flex-col gap-4"},me={class:"mb-1.5 text-sm text-ink-gray-5"},fe={__name:"DiscussionModal",props:z({title:{type:String,required:!0},doctype:{type:String,required:!0},docname:{type:String,required:!0}},{reloadTopics:{},reloadTopicsModifiers:{}}),emits:["update:reloadTopics"],setup(r){const _=O(r,"reloadTopics"),v=r,l=Z({title:"",reply:""}),w=x({url:"frappe.client.insert",makeParams(n){return{doc:{doctype:"Discussion Topic",reference_doctype:v.doctype,reference_docname:v.docname,title:l.title}}}}),h=x({url:"frappe.client.insert",makeParams(n){return{doc:{doctype:"Discussion Reply",topic:n.topic,reply:l.reply}}}}),C=n=>{w.submit({},{validate(){if(!l.title)return"Title cannot be empty.";if(!l.reply)return"Reply cannot be empty."},onSuccess(d){h.submit({topic:d.name},{onSuccess(){l.title="",l.reply="",_.value.reload(),n()}})},onError(d){var s;I.error(((s=d.messages)==null?void 0:s[0])||d)}})};return(n,d)=>(i(),P(e(te),{options:{title:e(K)(v.title),size:"2xl",actions:[{label:"Post",variant:"solid",onClick:s=>C(s)}]}},{"body-content":T(()=>[a("div",pe,[a("div",null,[c(e(ee),{modelValue:l.title,"onUpdate:modelValue":d[0]||(d[0]=s=>l.title=s),label:n.__("Title"),type:"text"},null,8,["modelValue","label"])]),a("div",null,[a("div",me,m(n.__("Details")),1),c(e(E),{content:l.reply,onChange:d[1]||(d[1]=s=>l.reply=s),editable:!0,fixedMenu:!0,editorClass:"prose-sm max-w-none border-b border-x bg-surface-gray-2 rounded-b-md py-1 px-2 min-h-[7rem]"},null,8,["content"])])])]),_:1},8,["options"]))}};function ye(){return window.scrollContainer}const ve={class:"text-xl font-semibold text-ink-gray-9"},ge={key:0},be=["onClick"],_e={class:"text-lg font-semibold mb-1 text-ink-gray-7"},he={class:"flex items-center text-ink-gray-5"},ke={class:"text-sm ml-3"},Te={key:1},xe={key:1},we={key:2,class:"flex flex-col items-center justify-center border-2 border-dashed mt-5 py-8 rounded-md"},Ce={class:""},$e={key:0,class:"font-medium mb-2"},Se={class:"text-ink-gray-5"},De={__name:"Discussions",props:{title:{type:String,required:!0},doctype:{type:String,required:!0},docname:{type:String,required:!0},emptyStateTitle:{type:String,default:""},emptyStateText:{type:String,default:"Start a discussion"},singleThread:{type:Boolean,default:!1},scrollToBottom:{type:Boolean,default:!1}},setup(r){const _=$(!0),v=$(null),l=R("$socket"),w=R("$user"),h=$(!1),C=window.read_only_mode,n=r;L(()=>{w.data&&s.reload(),l.on("new_discussion_topic",f=>{s.refresh()}),n.scrollToBottom&&setTimeout(()=>{d()},100)});const d=()=>{let f=ye();f.scrollTop=f.scrollHeight},s=x({url:"lms.lms.utils.get_discussion_topics",cache:["topics",n.doctype,n.docname],makeParams(){return{doctype:n.doctype,docname:n.docname,single_thread:n.singleThread}}}),g=f=>{_.value=!1,v.value=f},V=()=>{h.value=!0};return A(()=>{l.off("new_discussion_topic")}),(f,b)=>{var M;return i(),p(q,null,[a("div",null,[!r.singleThread&&!e(C)?(i(),P(e(S),{key:0,class:"float-right",onClick:b[0]||(b[0]=u=>V())},{default:T(()=>[B(m(f.__("New {0}").format(e(K)(r.title))),1)]),_:1})):k("",!0),a("div",ve,m(f.__(r.title)),1)]),(M=e(s).data)!=null&&M.length&&!r.singleThread?(i(),p("div",ge,[_.value?(i(!0),p(q,{key:0},F(e(s).data,(u,U)=>(i(),p("div",null,[a("div",{onClick:j=>g(u),class:J(["flex items-center cursor-pointer py-5 w-full",{"border-b":U+1!=e(s).data.length}])},[c(W,{user:u.user,size:"2xl",class:"mr-4"},null,8,["user"]),a("div",null,[a("div",_e,m(u.title),1),a("div",he,[a("span",null,m(u.user.full_name),1),a("span",ke,m(e(H)(u.creation)),1)])])],10,be)]))),256)):(i(),p("div",Te,[c(N,{topic:v.value,showTopics:_.value,"onUpdate:showTopics":b[1]||(b[1]=u=>_.value=u)},null,8,["topic","showTopics"])]))])):r.singleThread&&e(s).data?(i(),p("div",xe,[c(N,{topic:e(s).data,singleThread:r.singleThread},null,8,["topic","singleThread"])])):(i(),p("div",we,[c(e(se),{class:"w-7 h-7 text-ink-gray-4 stroke-1.5 mr-2"}),a("div",Ce,[r.emptyStateTitle?(i(),p("div",$e,m(f.__(r.emptyStateTitle)),1)):k("",!0),a("div",Se,m(f.__(r.emptyStateText)),1)])])),c(fe,{modelValue:h.value,"onUpdate:modelValue":b[2]||(b[2]=u=>h.value=u),title:f.__("New {0}").format(r.title),doctype:n.doctype,docname:n.docname,reloadTopics:e(s),"onUpdate:reloadTopics":b[3]||(b[3]=u=>oe(s)?s.value=u:null)},null,8,["modelValue","title","doctype","docname","reloadTopics"])],64)}}};export{De as _};
//# sourceMappingURL=Discussions-QlN9LAyu.js.map
